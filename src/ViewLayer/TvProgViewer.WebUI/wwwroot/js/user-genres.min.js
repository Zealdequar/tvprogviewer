function GetGenresForSelect(){$.ajax({url:"/Genre/GetGenres",method:"GET",dataType:"json",async:!1,success:function(n){var t="{",i,r,u;genres=n;for(i in n)r=n[i].GenreID,u=n[i].GenreName,t+='"'+r+'": "'+u+'", ';t.length>1&&(t=t.substring(0,t.length-2));t+="}";genresForSelect=$.parseJSON(t)}})}function upElem(n){$.ajax({url:"/Genre/UpGenreClassificateElem",type:"POST",contentType:"application/json; charset=utf-8",data:"{'genreClassificatorId':'"+n+"'}",success:function(){reload();setGrids();setTimeout(function(){$("#tblClassifGenres").jqGrid("setSelection",n,!0);var t=$("#tblClassifGenres").getGridParam("selrow"),i=$("#tblClassifGenres").getInd(t);$("#classifDiv").scrollTop(25*i)},500)}})}function downElem(n){$.ajax({url:"/Genre/DownGenreClassificateElem",type:"POST",contentType:"application/json; charset=utf-8",data:"{'genreClassificatorId':'"+n+"'}",success:function(){reload();setGrids();setTimeout(function(){$("#tblClassifGenres").jqGrid("setSelection",n,!0);var t=$("#tblClassifGenres").getGridParam("selrow"),i=$("#tblClassifGenres").getInd(t);$("#classifDiv").scrollTop(25*i)},500)}})}function UploadImage(n,t){var i=new FormData;return i.append("file",$("#GenrePath")[0].files[0]),i.append("GenreId",t.id),$.ajax({url:"/Genre/UploadFile",type:"POST",data:i,processData:!1,contentType:!1,success:function(){reload();setGrids()},error:function(){}}),[!0,"",!1]}function setGrids(){$("#tblUserGenres").jqGrid({url:"/Genre/GetGenres",datatype:"json",mtype:"Get",success:function(){},colNames:["","","Вкл./Выкл.","Пик.","Название"],colModel:[{key:!0,name:"GenreID",index:"GenreID",width:"0px",hidden:!0,editable:!0},{key:!1,name:"UID",index:"UID",width:"0px",hidden:!0,editable:!1},{key:!1,name:"Visible",index:"Visible",sortable:!0,width:"3%",align:"center",formatter:"checkbox",formatoptions:{disabled:!1},editable:!0},{key:!1,name:"GenrePath",index:"GenrePath",sortable:!1,width:"3%",align:"center",formatter:function(n){return n?n.indexOf("жанра")===-1?"<img src='"+n+"' alt='Картинка жанра' />":n:"<img src='/imgs/system/genre/untype.png' alt='Картинка жанра' />"},editable:!0,edittype:"file",editoptions:{enctype:"multipart/form-data"},search:!1},{key:!1,name:"GenreName",index:"GenreName",sortable:!0,width:"94%",editable:!0}],rowNum:20,loadComplete:function(){$("tr.jqgrow:odd").css("background","#EFFFEF");$("tr.jqgrow:odd").css("z-index",-100)},rowList:[10,20,30,40,50,100,500,1e3],height:"auto",width:"100%",autowidth:!0,rownumbers:!0,viewrecords:!0,reloadAfterEdit:!0,caption:"Типы передач",emptyrecords:"Жанры не обнаружены",loadonce:!0,jsonReader:{repeatitems:!1,root:function(n){return n},page:function(){return 1},total:function(n){return n.rowNum/n.height},records:function(n){return n.length}},pager:"#userGenresPager",reloadAfterSubmit:!0,editurl:"/Genre/UpdateGenre",afterSubmit:UploadImage}).navGrid("#userGenresPager",{edit:!0,add:!0,"delete":!0,search:!0,refresh:!0,searchtext:"Поиск жанра",addtext:"Добавить",edittext:"Изменить",deltext:"Удалить",refreshtext:"Обновить"},{zIndex:100,width:400,caption:"Поиск жанра",sopt:["cn"],reloadAfterSubmit:!0,closeAfterEdit:!0,afterSubmit:UploadImage},{zIndex:100,closeAfterAdd:!0,width:400,reloadAfterSubmit:!0,url:"/Genre/AddGenre",afterSubmit:UploadImage},{url:"/Genre/DeleteGenre",mtype:"POST",reloadAfterSubmit:!0,serializeDelData:function(n){return{genreId:n.id}}});$("#tblClassifGenres").jqGrid({url:"/Genre/GetGenreClassificators",datatype:"json",mtype:"Get",success:function(){},colNames:["","Тип жанра","","","Пик.","Содержит","Не содержит","","Удалить после","Действия"],colModel:[{key:!0,name:"GenreClassificatorID",index:"GenreClassificatorID",width:"0px",hidden:!0,editable:!0},{key:!1,name:"GID",index:"GID",width:"-10px",hidden:!1,editable:!0,formatter:"select",edittype:"select",editoptions:{value:genresForSelect,dataInit:function(n){$(n).iconselectmenu().iconselectmenu("menuWidget").addClass("ui-menu-icons customicons");for(var t in genres)$(n).find("option").each(function(){if(genres[t].GenreID==$(this).val())return $(this).attr("data-class","avatar"),$(this).attr("data-style","background-image: url('"+genres[t].GenrePath+"')"),!1})}}},{key:!1,name:"UID",index:"UID",width:"0px",hidden:!0,editable:!1},{key:!1,name:"GenreName",index:"GenreName",width:"-10px",hidden:!0,editable:!0},{key:!1,name:"GenrePath",index:"GenrePath",sortable:!1,width:"50px",align:"center",formatter:function(n){return n?n.indexOf("жанра")===-1?"<img src='"+n+"' alt='Картинка жанра' />":n:"<img src='/imgs/system/genre/untype.png' alt='Картинка жанра' />"},cellattr:function(n,t,i){return'title="'+i.GenreName+'"'},editable:!1,search:!1},{key:!1,name:"ContainPhrases",index:"ContainPhrases",sortable:!0,width:"200px",editable:!0},{key:!1,name:"NonContainPhrases",index:"NonContainPhrases",sortable:!0,width:"200px",editable:!0},{key:!1,name:"OrderCol",index:"OrderCol",width:"0%",hidden:!0,editable:!1},{key:!1,name:"DeleteAfterDate",index:"DeleteAfterDate",width:"200px",formatter:"date",hidden:!1,editable:!0,edittype:"text",editoptions:{size:10,maxlenght:10,dataInit:function(n){$(n).datepicker({dateFormat:"dd.mm.yy"})}}},{name:"Actions",index:"Actions",width:100,editable:!1,sortable:!1,align:"center",fixed:!0,hidedlg:!0,resizeable:!1,search:!1,viewable:!1,template:"actions",formatoptions:{keys:!0,editformbutton:!0,delbutton:!0,delOptions:{url:"/Genre/DeleteGenreClassificator",mtype:"POST",serializeDelData:function(n){return{genreClassificatorId:n.id}},afterShowForm:dlgRevisible}}}],afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]},rowNum:999999999,loadComplete:function(){$("tr.jqgrow:odd").css("background","#EFFFEF")},rowList:[10,20,30,40,50,100,500,1e3],height:"auto",autoResizing:{minColWidth:80},rownumbers:!0,viewrecords:!0,caption:"Классификатор (типов) передач",emptyrecords:"Элементы классификатора не обнаружены",formEditing:{width:400,zIndex:100,closeOnEscape:!0,closeAfterEdit:!0,reloadAfterSubmit:!0,afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]}},jsonReader:{repeatitems:!1,root:function(n){return n},page:function(){return 1},total:function(n){return n.rowNum/n.height},records:function(n){return n.length}},pager:"#classifGenresPager",closeAfterEdit:!0,reloadAfterEdit:!0,reloadAfterSubmit:!0,editurl:"/Genre/UpdateGenreClassificator",afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]},loadonce:!0,ondblClickRow:function(n){$(this).jqGrid("editGridRow",n)}}).navGrid("#classifGenresPager",{edit:!0,add:!0,"delete":!0,search:!0,refresh:!0,searchtext:"Поиск элемента",addtext:"Добавить",edittext:"Изменить",deltext:"Удалить",refreshtext:"Обновить"},{zIndex:100,width:400,caption:"Поиск элемента",sopt:["cn"],reloadAfterSubmit:!0,closeAfterEdit:!0,afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]},afterShowForm:dlgRevisible},{zIndex:100,closeAfterAdd:!0,width:400,url:"/Genre/AddGenreClassificator",afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]},afterShowForm:dlgRevisible},{url:"/Genre/DeleteGenreClassificator",mtype:"POST",serializeDelData:function(n){return{genreClassificatorId:n.id}},afterShowForm:dlgRevisible},{left:"40%",top:"30%",closeAfterSearch:!0,afterShowForm:dlgRevisible},{});jQuery("#tblClassifGenres").jqGrid("hideCol","GenreName")}function dlgRevisible(n){var t=n.closest("div.ui-jqdialog"),i=$("#tblUserGenres").find(">tbody>tr.jqgrow").filter(":last").offset();t.offset(i)}function reload(){$("#tblUserGenres").jqGrid("GridUnload");$("#tblClassifGenres").jqGrid("GridUnload")}var genresForSelect,genres,idx;$(function(){$("#btnUp").click(function(){var n=$("#tblClassifGenres").getGridParam("selrow"),t=$("#tblClassifGenres").jqGrid("getCell",n,"GenreClassificatorID");upElem(t)});$("#btnDown").click(function(){var n=$("#tblClassifGenres").getGridParam("selrow"),t=$("#tblClassifGenres").jqGrid("getCell",n,"GenreClassificatorID");downElem(t)});$("#genreTabs").tabs({activate:function(n,t){idx=t.newTab.index();idx===1&&(GetGenresForSelect(),$("#tblClassifGenres").jqGrid("GridUnload"),setGrids())}});GetGenresForSelect();$.widget("custom.iconselectmenu",$.ui.selectmenu,{_renderItem:function(n,t){var i=$("<li>"),r=$("<div>",{text:t.label});return t.disabled&&i.addClass("ui-state-disabled"),$("<span>",{style:t.element.attr("data-style"),"class":"ui-icon "+t.element.attr("data-class")}).appendTo(r),i.append(r).appendTo(n)}});setGrids()});