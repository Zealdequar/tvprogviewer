function GetRatingsForSelect(){$.ajax({url:"/Rating/GetRatings",method:"GET",dataType:"json",async:!1,success:function(n){var t="{",i,r,u;ratings=n;for(i in n)r=n[i].RatingID,u=n[i].RatingName,t+='"'+r+'": "'+u+'", ';t.length>1&&(t=t.substring(0,t.length-2));t+="}";ratingsForSelect=$.parseJSON(t)}})}function upElem(n){$.ajax({url:"/Rating/UpRatingClassificateElem",type:"POST",contentType:"application/json; charset=utf-8",data:"{'ratingClassificatorId':'"+n+"'}",success:function(){reload();setGrids();setTimeout(function(){$("#tblClassifRatings").jqGrid("setSelection",n,!0);var t=$("#tblClassifRatings").getGridParam("selrow"),i=$("#tblClassifRatings").getInd(t);$("#classifDiv").scrollTop(25*i)},500)}})}function downElem(n){$.ajax({url:"/Rating/DownRatingClassificateElem",type:"POST",contentType:"application/json; charset=utf-8",data:"{'ratingClassificatorId':'"+n+"'}",success:function(){reload();setGrids();setTimeout(function(){$("#tblClassifRatings").jqGrid("setSelection",n,!0);var t=$("#tblClassifRatings").getGridParam("selrow"),i=$("#tblClassifRatings").getInd(t);$("#classifDiv").scrollTop(25*i)},500)}})}function UploadImage(n,t){var i=new FormData;return i.append("file",$("#RatingPath")[0].files[0]),i.append("RatingId",t.id),$.ajax({url:"/Rating/UploadFile",type:"POST",data:i,processData:!1,contentType:!1,success:function(){reload();setGrids()},error:function(){}}),[!0,"",!1]}function setGrids(){$("#tblUserRatings").jqGrid({url:"/Rating/GetRatings",datatype:"json",mtype:"Get",success:function(){},colNames:["","","Вкл./Выкл.","Пик.","Название"],colModel:[{key:!0,name:"RatingID",index:"RatingID",width:"0px",hidden:!0,editable:!0},{key:!1,name:"UID",index:"UID",width:"0px",hidden:!0,editable:!1},{key:!1,name:"Visible",index:"Visible",sortable:!0,width:"3%",align:"center",formatter:"checkbox",formatoptions:{disabled:!1},editable:!0},{key:!1,name:"RatingPath",index:"RatingPath",sortable:!1,width:"3%",align:"center",formatter:function(n){return n?n.indexOf("рейтинга")===-1?"<img src='"+n+"' alt='Картинка рейтинга' />":n:"<img src='/imgs/system/rating/untype.png' alt='Картинка рейтинга' />"},editable:!0,edittype:"file",editoptions:{enctype:"multipart/form-data"},search:!1},{key:!1,name:"RatingName",index:"RatingName",sortable:!0,width:"94%",editable:!0}],rowNum:20,loadComplete:function(){$("tr.jqgrow:odd").css("background","#EFFFEF");$("tr.jqgrow:odd").css("z-index",-100)},rowList:[10,20,30,40,50,100,500,1e3],height:"auto",width:"100%",autowidth:!0,rownumbers:!0,viewrecords:!0,reloadAfterEdit:!0,caption:"Типы передач",emptyrecords:"Рейтинги не обнаружены",loadonce:!0,jsonReader:{repeatitems:!1,root:function(n){return n},page:function(){return 1},total:function(n){return n.rowNum/n.height},records:function(n){return n.length}},pager:"#userRatingsPager",reloadAfterSubmit:!0,editurl:"/Rating/UpdateRating",afterSubmit:UploadImage}).navGrid("#userRatingsPager",{edit:!0,add:!0,"delete":!0,search:!0,refresh:!0,searchtext:"Поиск рейтинга",addtext:"Добавить",edittext:"Изменить",deltext:"Удалить",refreshtext:"Обновить"},{zIndex:100,width:400,caption:"Поиск рейтинга",sopt:["cn"],reloadAfterSubmit:!0,closeAfterEdit:!0,afterSubmit:UploadImage},{zIndex:100,closeAfterAdd:!0,width:400,reloadAfterSubmit:!0,url:"/Rating/AddRating",afterSubmit:UploadImage},{url:"/Rating/DeleteRating",mtype:"POST",reloadAfterSubmit:!0,serializeDelData:function(n){return{ratingId:n.id}}});$("#tblClassifRatings").jqGrid({url:"/Rating/GetRatingClassificators",datatype:"json",mtype:"Get",success:function(){},colNames:["","Тип рейтинга","","","Пик.","Содержит","Не содержит","","Удалить после","Действия"],colModel:[{key:!0,name:"RatingClassificatorID",index:"RatingClassificatorID",width:"0px",hidden:!0,editable:!0},{key:!1,name:"RID",index:"RID",width:"-10px",hidden:!1,editable:!0,formatter:"select",edittype:"select",editoptions:{value:ratingsForSelect,dataInit:function(n){$(n).iconselectmenu().iconselectmenu("menuWidget").addClass("ui-menu-icons customicons");for(var t in ratings)$(n).find("option").each(function(){if(ratings[t].RatingID==$(this).val())return $(this).attr("data-class","avatar"),$(this).attr("data-style","background-image: url('"+ratings[t].RatingPath+"')"),!1})}}},{key:!1,name:"UID",index:"UID",width:"0px",hidden:!0,editable:!1},{key:!1,name:"RatingName",index:"RatingName",width:"-10px",hidden:!0,editable:!0},{key:!1,name:"RatingPath",index:"RatingPath",sortable:!1,width:"50px",align:"center",formatter:function(n){return n?n.indexOf("рейтинга")===-1?"<img src='"+n+"' alt='Картинка рейтинга' />":n:"<img src='/imgs/system/rating/untype.png' alt='Картинка рейтинга' />"},cellattr:function(n,t,i){return'title="'+i.RatingName+'"'},editable:!1,search:!1},{key:!1,name:"ContainPhrases",index:"ContainPhrases",sortable:!0,width:"200px",editable:!0},{key:!1,name:"NonContainPhrases",index:"NonContainPhrases",sortable:!0,width:"200px",editable:!0},{key:!1,name:"OrderCol",index:"OrderCol",width:"0%",hidden:!0,editable:!1},{key:!1,name:"DeleteAfterDate",index:"DeleteAfterDate",width:"200px",formatter:"date",hidden:!1,editable:!0,edittype:"text",editoptions:{size:10,maxlenght:10,dataInit:function(n){$(n).datepicker({dateFormat:"dd.mm.yy"})}}},{name:"Actions",index:"Actions",width:100,editable:!1,sortable:!1,align:"center",fixed:!0,hidedlg:!0,resizeable:!1,search:!1,viewable:!1,template:"actions",formatoptions:{keys:!0,editformbutton:!0,delbutton:!0,delOptions:{url:"/Rating/DeleteRatingClassificator",mtype:"POST",serializeDelData:function(n){return{ratingClassificatorId:n.id}},afterShowForm:dlgRevisible}}}],afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]},rowNum:999999999,loadComplete:function(){$("tr.jqgrow:odd").css("background","#EFFFEF")},rowList:[10,20,30,40,50,100,500,1e3],height:"auto",autoResizing:{minColWidth:80},rownumbers:!0,viewrecords:!0,caption:"Классификатор (рейтингов) передач",emptyrecords:"Элементы классификатора не обнаружены",formEditing:{width:400,zIndex:100,closeOnEscape:!0,closeAfterEdit:!0,reloadAfterSubmit:!0,afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]}},jsonReader:{repeatitems:!1,root:function(n){return n},page:function(){return 1},total:function(n){return n.rowNum/n.height},records:function(n){return n.length}},pager:"#classifRatingsPager",closeAfterEdit:!0,reloadAfterEdit:!0,reloadAfterSubmit:!0,editurl:"/Rating/UpdateRatingClassificator",loadonce:!0,ondblClickRow:function(n){$(this).jqGrid("editGridRow",n)}}).navGrid("#classifRatingsPager",{edit:!0,add:!0,"delete":!0,search:!0,refresh:!0,searchtext:"Поиск элемента",addtext:"Добавить",edittext:"Изменить",deltext:"Удалить",refreshtext:"Обновить"},{zIndex:100,width:400,caption:"Поиск элемента",sopt:["cn"],reloadAfterSubmit:!0,closeAfterEdit:!0,afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]},afterShowForm:dlgRevisible},{zIndex:100,closeAfterAdd:!0,width:400,url:"/Rating/AddRatingClassificator",afterSubmit:function(){return $(this).jqGrid("setGridParam",{datatype:"json"}),[!0]},afterShowForm:dlgRevisible},{url:"/Rating/DeleteRatingClassificator",mtype:"POST",serializeDelData:function(n){return{ratingClassificatorId:n.id}},afterShowForm:dlgRevisible},{left:"40%",top:"30%",closeAfterSearch:!0,afterShowForm:dlgRevisible},{});jQuery("#tblClassifRatings").jqGrid("hideCol","RatingName")}function dlgRevisible(n){var t=n.closest("div.ui-jqdialog"),i=$("#tblUserRatings").find(">tbody>tr.jqgrow").filter(":last").offset();t.offset(i)}function reload(){$("#tblUserRatings").jqGrid("GridUnload");$("#tblClassifRatings").jqGrid("GridUnload")}var ratingsForSelect,ratings,idx;$(function(){$("#btnUp").click(function(){var n=$("#tblClassifRatings").getGridParam("selrow"),t=$("#tblClassifRatings").jqGrid("getCell",n,"RatingClassificatorID");upElem(t)});$("#btnDown").click(function(){var n=$("#tblClassifRatings").getGridParam("selrow"),t=$("#tblClassifRatings").jqGrid("getCell",n,"RatingClassificatorID");downElem(t)});$("#ratingTabs").tabs({activate:function(n,t){idx=t.newTab.index();idx===1&&(GetRatingsForSelect(),$("#tblClassifRatings").jqGrid("GridUnload"),setGrids())}});GetRatingsForSelect();$.widget("custom.iconselectmenu",$.ui.selectmenu,{_renderItem:function(n,t){var i=$("<li>"),r=$("<div>",{text:t.label});return t.disabled&&i.addClass("ui-state-disabled"),$("<span>",{style:t.element.attr("data-style"),"class":"ui-icon "+t.element.attr("data-class")}).appendTo(r),i.append(r).appendTo(n)}});setGrids()});